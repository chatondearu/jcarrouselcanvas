/**
 *
 * no-detail
 *
 * <p>***</p>
 *
 * @name JcarrouselCanvas
 * @author Romain Lienard <crow.is.ur.leader@gmail.com>
 * @http:
 * @copyright (c)2012 Romain Lienard
 * @version 1.0.2
 * @package ***
 * @date: 14/02/12
 * @time: 13:27
 *
 *	Permission is hereby granted, free of charge, to any person obtaining a copy of this
 *	software and associated documentation files (the "Software"), to deal in the Software
 *	without restriction, including without limitation the rights to use, copy, modify, merge,
 *	publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons
 *	to whom the Software is furnished to do so, subject to the following conditions:
 *
 * 	The above copyright notice and this permission notice shall be included in all copies
 *	or substantial portions of the Software.
 *
 *	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING
 *	BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 *	NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
 *	DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * 	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 *
 *
 **/
function JcarrousselCanvas(a,b,c){function p(a,b,c){this.x=typeof a!="undefined"?a:0;this.y=typeof b!="undefined"?b:0;this.z=typeof c!="undefined"?c:0}var d=this,e=0,f=.3,g="ontouchstart"in window,h=g?"touchstart":"mousedown",i=g?"touchmove":"mousemove",j=g?"touchend":"mouseup",k={imgHeight:0,imgWidth:0,border:false,borderWidth:3,borderColor:"#000000",reflect:true,reflectHeight:.5,reflectOpacity:.3,reflectDistance:5,reflectBackgournd:"#ffffff",shadow:false,shadowDistance:5,shadowWidth:10,rayon:200,hauteur:30,verticalAlign:null,horizontalAlign:null,speedFrequence:1e3/30,startAngle:90,stepAngle:null,perspective:.7,loose:true,step:true,setStep:true};this.imgs=typeof b!="undefined"&&b.constructor==Array?b:new Array;this.eventInfo={isDown:false,onMove:false,moving:false,startMove:{},endMove:{},startDown:{},endUp:{}};a=typeof a!="undefined"&&a.constructor==String&&a!=""?a:"carrousel";var l=document.getElementById(a);if(l.tagName!="CANVAS"){var m=document.createElement("canvas");m.id=a+"Canvas";m.height=l.offsetHeight;m.width=l.offsetWidth;l.appendChild(m);a=a+"Canvas"}l=document.getElementById(a);var n=l!=null?l.getContext("2d"):null,o={extend:function(a,b){if(arguments.length>2){for(var c=1;c<arguments.length;c++){o.extend(a,arguments[c])}}else{for(var d in b){a[d]=b[d]}}return a},toRad:function(a){return Math.PI*a/180},getXformEllipse:function(a){return k.horizontalAlign+k.rayon*Math.cos(a)},getYformEllipse:function(a){return k.verticalAlign+k.hauteur*Math.sin(a)},getDegFromXY:function(a,b){var c=Math.atan(b/a)*180/Math.PI;if(a<0)c+=180;return c}};if(typeof c!="undefined"&&c.constructor==Object)k=o.extend(k,c);if(k.stepAngle==null)k.stepAngle=360/d.imgs.length;if(k.horizontalAlign==null)k.horizontalAlign=l.width/2;if(k.verticalAlign==null)k.verticalAlign=l.height/2;this.actualAngle=0;var q={height:function(){return l.height},width:function(){return l.width},clean:function(){var b=document.getElementById(a);var c=b!=null?b.getContext("2d"):null;c.clearRect(0,0,b.width,b.height)},drawImg:function(b,c,d,e,f){var g=document.getElementById(a);var h=g!=null?g.getContext("2d"):null;h.save();if(k.shadow||k.border){h.beginPath();h.rect(c-e/2,d-f/2,e,f);if(k.shadow){h.shadowColor=k.borderColor;h.shadowBlur=k.shadowWidth;h.shadowOffsetY=k.shadowDistance}h.fill();h.restore();h.save();if(k.border){h.lineWidth=k.borderWidth*2;h.strokeStyle=k.borderColor;h.stroke()}}h.drawImage(b,c-e/2,d-f/2,e,f);if(k.reflect){h.translate(c-e/2,d+f*1.5+k.reflectDistance);h.scale(1,-1);h.globalAlpha=k.reflectOpacity;h.drawImage(b,0,0,e,f);h.globalAlpha=1;var i=h.createLinearGradient(0,0,0,f*(1-k.reflectHeight)*2);i.addColorStop(1,"transparent");i.addColorStop(.5,k.reflectBackgournd);h.fillStyle=i;h.fillRect(-1,-1,e+2,f+2)}h.restore()}},r=function(){for(var a in d.imgs){var b=k.startAngle+d.actualAngle+k.stepAngle*d.imgs[a].num;d.imgs[a].img.pos.x=o.getXformEllipse(o.toRad(b));d.imgs[a].img.pos.y=o.getYformEllipse(o.toRad(b))}d.imgs.sort(function(a,b){if(k.rayon>=k.hauteur)return a.img.pos.y-b.img.pos.y;else return a.img.pos.x-b.img.pos.x})},s=function(a){var b=0;for(var c in d.imgs){d.imgs[c].img=new Image;d.imgs[c].img.onload=function(){if(++b>=d.imgs.length){a()}};d.imgs[c].img.src=d.imgs[c].url}},t=function(){var a=0;for(var b in d.imgs){var c=k.startAngle+d.actualAngle+k.stepAngle*a;if(typeof d.imgs[b].id=="undefined")d.imgs[b].id=b;if(typeof d.imgs[b].callback=="undefined")d.imgs[b].callback=function(a){};d.imgs[b].num=a;d.imgs[b].img.pos=new p(o.getXformEllipse(o.toRad(c)),o.getYformEllipse(o.toRad(c)),0);a++}d.imgs.sort(function(a,b){if(k.rayon>=k.hauteur)return a.img.pos.y-b.img.pos.y;else return a.img.pos.x-b.img.pos.x})},u=function(){for(var a in d.imgs){var b=d.imgs[a].img,c=b.pos.x,e=b.pos.y,f=k.imgHeight==0?b.height:k.imgHeight,g=k.imgWidth==0?b.width:k.imgWidth;if(k.perspective>0){var h=(e-(k.verticalAlign-k.hauteur))/(k.hauteur*2);var i=(c-(k.horizontalAlign-k.rayon))/(k.rayon*2);f=f*((1-k.perspective)*h+k.perspective);g=g*((1-k.perspective)*h+k.perspective)}q.drawImg(b,c,e,g,f)}};var v={actualStep:function(){return Math.round(d.actualAngle/k.stepAngle)},stepAnimation:function(a){if(a==null)a=v.actualStep();var b=k.stepAngle*a;var c=b-d.actualAngle;if(c>f*2||c<-f*2){d.actualAngle+=c*f;w.start(a)}else{d.actualAngle=b;q.clean();r();u()}}},w={fq:k.speedFrequence,t:null,animate:function(a){if(k.loose)d.actualAngle+=e;d.actualAngle=d.actualAngle%360;if(e<0)e+=f;else e-=f;q.clean();r();u();if((e>f||e<-f)&&k.loose)w.start(a);else{if(k.step){v.stepAnimation(a)}}},start:function(a){w.t=setTimeout(function(){w.animate(a)},w.fq)},stop:function(){clearTimeout(w.t)}};this.setStep=function(a){w.start(a)};var x=function(){var a=l.offsetX?d.eventInfo.startMove.x-l.offsetX:d.eventInfo.startMove.x-l.offsetLeft,b=l.offsetY?d.eventInfo.startMove.y-l.offsetY:d.eventInfo.startMove.y-l.offsetTop,c=null,e=null;for(var f in d.imgs){var g=d.imgs[f],h=g.img.pos.x,i=g.img.pos.y,j=k.imgHeight==0?g.img.height:k.imgHeight,m=k.imgWidth==0?g.img.width:k.imgWidth;if(k.perspective>0){var n=(i-(k.verticalAlign-k.hauteur))/(k.hauteur*2);var o=(h-(k.horizontalAlign-k.rayon))/(k.rayon*2);j=j*((1-k.perspective)*n+k.perspective);m=m*((1-k.perspective)*n+k.perspective)}if(h+m/2>a&&h-m/2<a&&i+j/2>b&&i-j/2<b){c=d.imgs.length-g.num;e=g}}if(c!=null){if(k.setStep&&k.step)d.setStep(c);e.callback(e.id)}};var y=function(){l.addEventListener(h,function(a){a.returnValue=false;if(a.preventDefault){a.preventDefault()}d.eventInfo.isDown=true;d.eventInfo.startMove=new p(g?a.touches[0].pageX||a.changedTouches[0].pageX:a.pageX,g?a.touches[0].pageY||a.changedTouches[0].pageY:a.pageY,0);w.stop();e=0},false);l.addEventListener(i,function(a){if(d.eventInfo.isDown&&!d.eventInfo.onMove){a.returnValue=false;if(a.preventDefault){a.preventDefault()}d.eventInfo.onMove=true;d.eventInfo.moving=true;d.eventInfo.endMove=new p(g?a.touches[0].pageX||a.changedTouches[0].pageX:a.pageX,g?a.touches[0].pageY||a.changedTouches[0].pageY:a.pageY,0);var b=l.offsetX?d.eventInfo.startMove.x-l.offsetX:d.eventInfo.startMove.x-l.offsetLeft,c=l.offsetY?d.eventInfo.startMove.y-l.offsetY:d.eventInfo.startMove.y-l.offsetTop,f=l.offsetX?d.eventInfo.endMove.x-l.offsetX:d.eventInfo.endMove.x-l.offsetLeft,h=l.offsetX?d.eventInfo.endMove.y-l.offsetY:d.eventInfo.endMove.y-l.offsetTop;q.clean();r();u();e=(o.getDegFromXY(f,h)-o.getDegFromXY(b,c))*Math.PI;d.actualAngle+=e;d.actualAngle=d.actualAngle%360;d.eventInfo.startMove=new p(g?a.touches[0].pageX||a.changedTouches[0].pageX:a.pageX,g?a.touches[0].pageY||a.changedTouches[0].pageY:a.pageY,0);return d.eventInfo.onMove=false}},false);l.addEventListener(j,function(a){a.returnValue=false;if(a.preventDefault){a.preventDefault()}d.eventInfo.isDown=false;if(!d.eventInfo.moving)x();else w.start(null);d.eventInfo.moving=false},false)};this.init=function(){q.clean();t();u();y()};s(this.init)}